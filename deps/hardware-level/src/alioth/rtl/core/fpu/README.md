# FPU-SP 单精度浮点运算单元

本浮点运算单元符合 IEEE 754-2008 标准。支持的操作包括**比较**、**最小-最大**、**类型转换**、**加法**、**减法**、**乘法**、**融合乘加**、**平方根**和**除法**，均为单精度。除**平方根**和**除法**外，所有操作均为流水线实现。

本单元在输出为 **nan**（非数）时，采用规范的 **nan** 形式，例如 0x7FC00000。因此，为了与 testfloat 数据正确比较 **nan** 的生成，增加了额外的判断条件。

**平方根**和**除法**运算共用同一个子单元，但采用不同的路径（算法）。该子单元有一个通用变量 **_performance_**。若需快速的功能迭代，请使用 **1**，若需较慢的定点迭代，请使用 **0**。本单元还自带乘法器。

## 设计

本浮点运算单元将单精度转换为伪扩展精度。该实现的主要优点是设计所需资源较少，因为无需在流水线中实现扩展以处理非规格化数。这意味着所有浮点数都通过伪扩展精度实现了规格化。

|        | 符号位 | 指数位 | 尾数位 |
|:------:|:------:|:------:|:------:|
| 单精度 | 1      | 8      | 23     |
| 伪扩展 | 1      | 9      | 23     |

## 延迟

| 比较 | 最大 | 转换 | 加法 | 减法 | 乘法 | 融合乘加 |
|:----:|:----:|:----:|:----:|:----:|:----:|:--------:|
| 1    | 1    | 1    | 3    | 3    | 3    | 3        |

| performance | 除法 | 平方根 |
|:-----------:|:----:|:------:|
| 0           | 29   | 28     |
| 1           | 12   | 14     |

## 单元结构

![fp_unit](image/fpu.svg)

### 信号说明

| 操作 | 类型 |
|:-----|:-----|
| fmadd | $(data1*data2)+data3$ |
| fmsub | $(data1*data2)-data3$ |
| fnmsub | $-(data1*data2)+data3$ |
| fnmadd | $-(data1*data2)-data3$ |
| fadd | $data1+data2$ |
| fsub | $data1-data2$ |
| fmul | $data1*data2$ |
| fdiv | $data1/data2$ |
| fsqrt | $\sqrt{data1}$ |

| 操作 | rm  | 类型 |
|:-----|:---|:-----|
| fsgnj | "000" | J |
| fsgnj | "001" | JN |
| fsgnj | "010" | JX |

| 操作 | rm  | 类型 |
|:-----|:---|:-----|
| fcmp | "000" | EQ |
| fcmp | "001" | LT |
| fcmp | "010" | LE |

| 操作 | rm  | 类型 |
|:-----|:---|:-----|
| fmax | "000" | MIN |
| fmax | "001" | MAX |

| 操作 | op.fcvt_op | fmt | 类型 |
|:-----|:-----------|:----|:-----------------------------|
| fcvt_f2i | "00" | "00" | 浮点转有符号32位整数  |
| fcvt_f2i | "01" | "00" | 浮点转无符号32位整数 |

| 操作 | op.fcvt_op | fmt | 类型 |
|:-----|:-----------|:----|:-----------------------------|
| fcvt_i2f | "00" | "00" | 有符号32位整数转浮点  |
| fcvt_i2f | "01" | "00" | 无符号32位整数转浮点 |

| fmt  | 类型 |
|:-----|:-----|
| "00" | 浮点 |

| rm   | 类型 |
|:-----|:-----|
| "000" | 最近偶数(RNE) |
| "001" | 向零舍入(RTZ) |
| "010" | 向下舍入(RDN) |
| "011" | 向上舍入(RUP) |
| "100" | 最近最大幅度(RMM) |

| 标志位 | 类型 |
|:-------|:-----|
| "00001" | NX |
| "00010" | UF |
| "00100" | OF |
| "01000" | DZ |
| "10000" | NV |

---

## 移植说明：RISC-V F 扩展指令与本 FPU 操作对应关系

本节说明 RISC-V F 扩展（单精度浮点）各条指令与本 FPU 单元信号/操作的对应关系，便于 SoC 集成和指令译码。

| RISC-V 指令 | FPU 操作信号 | 备注 |
|:------------|:-------------|:-----|
| FADD.S      | fadd         | 单精度加法 |
| FSUB.S      | fsub         | 单精度减法 |
| FMUL.S      | fmul         | 单精度乘法 |
| FDIV.S      | fdiv         | 单精度除法 |
| FSQRT.S     | fsqrt        | 单精度平方根 |
| FSGNJ.S     | fsgnj        | 信号 rm 区分 J/JN/JX |
| FSGNJN.S    | fsgnj        | rm="001" |
| FSGNJX.S    | fsgnj        | rm="010" |
| FMIN.S      | fmax         | rm="000" (MIN) |
| FMAX.S      | fmax         | rm="001" (MAX) |
| FMADD.S     | fmadd        | 融合乘加 |
| FMSUB.S     | fmsub        | 融合乘减 |
| FNMADD.S    | fnmadd       | 负融合乘加 |
| FNMSUB.S    | fnmsub       | 负融合乘减 |
| FEQ.S       | fcmp         | rm="000" (EQ) |
| FLT.S       | fcmp         | rm="001" (LT) |
| FLE.S       | fcmp         | rm="010" (LE) |
| FCVT.W.S    | fcvt_f2i     | op.fcvt_op="00", fmt="00"（转有符号32位整数）|
| FCVT.WU.S   | fcvt_f2i     | op.fcvt_op="01", fmt="00"（转无符号32位整数）|
| FCVT.S.W    | fcvt_i2f     | op.fcvt_op="00", fmt="00"（有符号32位整数转浮点）|
| FCVT.S.WU   | fcvt_i2f     | op.fcvt_op="01", fmt="00"（无符号32位整数转浮点）|
| FMV.X.S     | fcvt_f2i     | 仅做位拷贝，特殊处理 |
| FMV.S.X     | fcvt_i2f     | 仅做位拷贝，特殊处理 |

### 舍入模式与异常标志

- 所有涉及舍入的指令（如 FADD.S、FSUB.S、FMUL.S、FDIV.S、FSQRT.S、FCVT 等）均支持 RISC-V F 扩展定义的 5 种舍入模式（RNE、RTZ、RDN、RUP、RMM），通过 rm 信号选择。
- 异常标志（NX、UF、OF、DZ、NV）与 RISC-V F 扩展一致。

### 特别说明

- 本单元所有输入输出均为 IEEE 754 单精度格式，完全兼容 RISC-V F 扩展。
- 伪扩展精度仅用于内部实现，对外接口不变。
- NaN、无穷大、0、非规格化数等特殊数值处理方式与 RISC-V F 扩展一致。

---

## 接口移植说明：fp_unit_i / fp_unit_o

本单元采用如下顶层接口：

```verilog
    input  fp_unit_in_type  fp_unit_i,
    output fp_unit_out_type fp_unit_o,
```

### 输入结构（fp_unit_in_type）

- `fp_unit_in_type` 仅包含一个成员 `fp_exe_i`，类型为 `fp_exe_in_type`。
- `fp_exe_in_type` 字段说明：
  - `data1 [31:0]`：操作数1（如 rs1）
  - `data2 [31:0]`：操作数2（如 rs2）
  - `data3 [31:0]`：操作数3（如 rs3，主要用于融合乘加类指令）
  - `op`：操作类型，详见 `fp_operation_type`，由译码器根据指令设置
  - `fmt [1:0]`：格式（单精度为 "00"）
  - `rm [2:0]`：舍入模式（对应 RISC-V 指令的 rm 字段）
  - `enable`：启动信号，高有效

#### 输入信号与 RISC-V 指令映射

- 指令译码后，将 rs1、rs2、rs3、rm、fmt 直接赋值到对应字段。
- `op` 字段由译码器根据指令类型设置（详见“移植说明”表格）。
- `enable` 由上层控制，指令有效时拉高。

### 输出结构（fp_unit_out_type）

- `fp_unit_out_type` 仅包含一个成员 `fp_exe_o`，类型为 `fp_exe_out_type`。
- `fp_exe_out_type` 字段说明：
  - `result [31:0]`：浮点运算结果（或类型转换结果）
  - `flags [4:0]`：异常标志（NX、UF、OF、DZ、NV），与 RISC-V F 扩展一致
  - `ready`：结果有效信号，高有效

#### 输出信号与 RISC-V 指令映射

- `result` 可直接写回浮点寄存器或整数寄存器（如 FCVT/类型转换指令）。
- `flags` 可直接用于 FCSR 寄存器的异常标志位。
- `ready` 用于指示结果是否可用，便于流水线/握手控制。

### 移植建议

- 指令译码阶段需将 RISC-V 指令字段正确映射到 `fp_unit_i` 的各成员。
- 运算完成后，`fp_unit_o` 的 `result` 和 `flags` 可直接用于架构寄存器和异常处理。
- 若需支持多精度，可扩展 `fmt` 字段和相关数据宽度。

---
